const app=new Vue({el:"#app",data:{chatwith:_id_user,user:_token,online:[],messages:[],player:{},playing:null,progress:0,audio_meta:{},file_type:null},methods:{getMessage:function(){const vm=this;let start=0;async function sendRequest(){await $.get("./inc/message.inc.php?start="+start+"&from="+vm.user+"&to="+vm.chatwith,(function(data){data.data&&(data.data.forEach(item=>{start=item.id;const t=new Date(item.time),time=`${t.getHours()}:${t.getMinutes()<10?"0":""}${t.getMinutes()}`;let audio_id=null;"mus"==item.type&&(audio_id=Math.random().toString(36).substr(2,5),vm.player[audio_id]={src:item.message,playing:!1}),vm.messages.push({message:item.message,id:item.who_to,type:item.type,to:!1,time:time,audio_id:audio_id})}),$(".messages").animate({scrollTop:$(".messages")[0].scrollHeight}))})),null!=vm.chatwith&&setTimeout(sendRequest,1800)}sendRequest()},WhoIsOnline:function(){$.get("./inc/social.inc.php?user="+this.user,(function(areOnline){let _users,users;app.online=[],areOnline.users.sort((function(a,b){return""==a.last_msg?1:""==b.last_msg?-1:0})).forEach(user=>{app.online.push({id:user.chat_auth,full_name:user.full_name,profile_picture:user.profile_picture,last_msg:user.last_msg,time:user.time,type:user.type,online:user.online})})}))},switchMsgdata:function(){let vm=this;this.messages.forEach(message=>{vm.chatwith==message.id&&(message.to=!0)})},startChat:function(index){this.chatwith=this.online[index].id,history.pushState({},"","?id="+this.chatwith),document.title=this.online[index].full_name},sendUpload:function(data){$.ajax({url:`inc/file.inc.php?from=${app.user}&to=${app.chatwith}&type=${app.file_type}`,type:"POST",data:data,cache:!1,contentType:!1,processData:!1,success:function(data){data.success&&($("#upload-status").html(""),app.messages.push({message:data.file,id:app.user,type:app.file_type,to:!0,time:data.time,audio_id:null}),$(".messages").animate({scrollTop:$(".messages")[0].scrollHeight}))}})},playerUpdate:function(data){this.player.push(data)},checkrequest:function(){},sendMessage:function(type="txt"){const vm=this,msg=$("#msg-form").val(),time=new Date,timeString=`${time.getHours()}:${time.getMinutes()<10?"0":""}${time.getMinutes()}`,data={message:msg,from:this.user,to:this.chatwith};$.post("./inc/message.inc.php",data,(function(data){$("#msg-form").val(""),$(".messages").animate({scrollTop:$(".messages")[0].scrollHeight})}))},goBack:function(){this.chatwith=null},play:function(id){vm=this;const player=document.getElementById("audioPlayer");this.playing!=id&&(player.src="inc/"+this.player[id].src,this.playing=id),this.player[id].playing?(player.pause(),this.player[id].playing=!1):(player.play(),this.player[id].playing=!0,$("#audioPlayer").on("timeupdate",(function(){vm.progress=this.currentTime/this.duration*100,$("#p-"+vm.playing).css("width",vm.progress+"%"),100==vm.progress&&(vm.player[id].playing=!1,vm.playing=null,player.pause())})))},openModal:function(id){}},watch:{chatwith:function(){null==this.chatwith&&(document.title="messages",history.pushState(null,null,"./message.php")),this.messages=[],this.getMessage()},messages:function(){this.switchMsgdata()}},mounted:function(){_id_user&&this.getMessage(),this.WhoIsOnline(),this.checkrequest()}}),handleUpload=(type,event)=>{app.file_type=type;const files=event.target.files,formData=new FormData;formData.append("uploadedFile",files[0]),$("#upload-status").html("Uploading..."),app.sendUpload(formData)};$(document).ready((function(){$("#songUpload").on("change",(function(event){handleUpload("mus",event)})),$("#imgUpload").on("change",(function(event){handleUpload("img",event)}))}));